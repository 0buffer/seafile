CC = gcc

# Default make goal is for nautilus 3; use `make v2' to compile for nautilus 2
ifeq (${MAKECMDGOALS}, v2)
# compile for nautilus 2
	TARGET = libseafile_nautilus2_ext.so
	NAUTILUS_VERSION = 2
	NAUTILUS_EXT_DIR = $(DESTDIR)/usr/lib/nautilus/extensions-2.0
else
# compile for nautilus 3
	TARGET = libseafile_nautilus3_ext.so
	NAUTILUS_VERSION = 3
	NAUTILUS_EXT_DIR = $(DESTDIR)/usr/lib/nautilus/extensions-3.0
endif

SEAF_EXT_UI_DIR = ${NAUTILUS_EXT_DIR}/seafile/

CFLAGS = @LIBNAUTILUS_EXTENSION_CFLAGS@ \
	-I../common -fPIC -Wall -Werror -g -O \
	-DSEAF_EXT_UI_DIR=\"${SEAF_EXT_UI_DIR}\" \
	-DNAUTILUS_VERSION=${NAUTILUS_VERSION}

LDFLAGS = -g -shared -Wl,-soname,${TARGET} \
	@LIBNAUTILUS_EXTENSION_LIBS@

MODULES = platform.c  seaf-ext.c seaf-menu.c \
	seaf-dlgs.c \
	../common/strbuf.c ../common/seaf-ext-log.c \
	../common/seaf-utils.c ../common/menu-engine.c

OBJECTS = ${MODULES:%.c=%.o} 

ICON_DIR = ../common/icons
ICON_EXT = .ico

UIFILES = ${ICON_DIR}/seaf_ext*${ICON_EXT}

all: ${TARGET}
v3: ${TARGET}

.deps: $(MODULES)      
	$(CC) $(CFLAGS) -MM $^ > $@

include .deps

%.o : %.c
	$(CC) $(CFLAGS) $< -c -o $@

${TARGET}: ${OBJECTS} .deps
	${CC} ${LDFLAGS} ${OBJECTS} -o $@


install: ${TARGET}
	mkdir -p ${SEAF_EXT_UI_DIR}
	cp -f ${TARGET} ${NAUTILUS_EXT_DIR}
	cp -f ${UIFILES} ${SEAF_EXT_UI_DIR}

uninstall:
	rm -f ${NAUTILUS_EXT_DIR}/${TARGET}
	rm -rf ${SEAF_EXT_UI_DIR}

clean:
	rm -f *.o *.so ../common/*.o .deps

distclean:
	rm -f Makefile

.PHONY: all clean distclean install uninstall
